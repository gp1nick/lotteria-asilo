<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lotteria Asilo Mergozzo</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Comic+Neue&display=swap');

  body {
    font-family: 'Comic Neue', cursive, sans-serif;
    margin: 0; padding: 0; background: #f9f6f2;
    display: flex; flex-direction: column; align-items: center;
    min-height: 100vh;
    height: 100vh;
    overflow: hidden;
  }

  header {
    background: #ffcc00;
    width: 100%; padding: 15px;
    text-align: center;
    font-size: 1.2em;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    flex-shrink: 0;
  }

  #form-area {
    width: 100%;
    max-width: 700px;
    padding: 10px 20px;
    box-sizing: border-box;
    flex-shrink: 0;
    background: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-top: 10px;
    border-radius: 8px;
  }

  #form-area input[type="text"] {
    font-size: 1em;
    padding: 8px;
    margin-right: 10px;
    width: 60%;
    border: 2px solid #ccc;
    border-radius: 5px;
  }

  #form-area button {
    font-size: 1em;
    padding: 8px 15px;
    cursor: pointer;
    border-radius: 5px;
    border: none;
    background-color: #ff9900;
    color: white;
    transition: background-color 0.3s;
  }
  #form-area button:hover {
    background-color: #e68a00;
  }

  #board {
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    grid-gap: 6px;
    width: 100vw;
    flex-grow: 1;
    max-height: calc(100vh - 190px);
    padding: 10px;
    box-sizing: border-box;
    overflow-y: auto;
  }

  .cell {
    background: #eee;
    border: 2px solid #ccc;
    border-radius: 6px;
    text-align: center;
    cursor: pointer;
    user-select: none;
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 8vh;
    transition: background-color 0.3s, border-color 0.3s;
    padding: 4px 2px;
  }

  .cell.selected {
    background-color: #ffd966;
    border-color: #ff9900;
    font-weight: bold;
  }

  .cell.taken {
    background-color: #bbb;
    border-color: #666;
    color: #333;
    cursor: not-allowed;
  }

  .number {
    font-size: 1.8em;
    line-height: 1;
    flex: 1 0 auto;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .child-name {
    font-size: 1.1em;
    line-height: 1.1;
    margin-top: 2px;
    max-height: 3em;
    overflow-wrap: break-word;
    word-break: break-word;
    width: 100%;
    flex: 1 0 auto;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    padding: 0 2px;
  }

  #admin-btn {
    margin-left: 10px;
    background-color: #666;
  }

  #admin-btn:hover {
    background-color: #444;
  }

  #admin-area {
    margin-top: 10px;
    text-align: center;
  }

  #admin-unlock {
    display: none;
    margin-top: 10px;
  }

  #admin-unlock input {
    padding: 5px;
    font-size: 1em;
    border-radius: 5px;
    border: 2px solid #ccc;
    width: 200px;
  }

  #admin-unlock button {
    padding: 6px 12px;
    font-size: 1em;
    border-radius: 5px;
    border: none;
    background-color: #444;
    color: white;
    margin-left: 5px;
    cursor: pointer;
  }

  #admin-unlock button:hover {
    background-color: #222;
  }

  #admin-logout-btn {
    display: none;
    margin-left: 10px;
    background-color: #900;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
  }

  #admin-logout-btn:hover {
    background-color: #700;
  }

  #message {
    margin-top: 8px;
    font-weight: bold;
    min-height: 20px;
    color: #006600;
  }

  /* Scrollbar styling for board */
  #board::-webkit-scrollbar {
    width: 8px;
  }
  #board::-webkit-scrollbar-thumb {
    background: #ff9900;
    border-radius: 4px;
  }

  /* Print styles */
  @media print {
    body {
      background: white;
      color: black;
      overflow: visible !important;
      height: auto !important;
    }
    #form-area, header, #admin-btn, #admin-unlock, #admin-logout-btn, #message {
      display: none !important;
    }
    #board {
      width: 100%;
      max-height: none;
      grid-gap: 4px;
      padding: 0;
    }
    .cell {
      border: 1px solid black !important;
      height: 25mm !important;
      font-size: 14pt !important;
      padding: 2mm !important;
    }
    .child-name {
      font-size: 10pt !important;
    }
    @page {
      size: A4 landscape;
      margin: 5mm;
    }
  }
</style>
</head>
<body>

<header>
  Lotteria di fine anno dell'asilo di Mergozzo!!  
  Scegli uno o più numeri, in palio tanti premi!!<br />
  Per ogni numero sono richiesti 2,50€ o un'offerta superiore da lasciare in busta chiusa nell'armadietto di Arianna F. ;) Grazie mille del tuo aiuto ;)
</header>

<div id="form-area">
  <input type="text" id="childName" placeholder="Nome e Cognome bambino/a" autocomplete="off"/>
  <button id="confirm-btn">Conferma scelta</button>
  <button id="admin-btn">Admin</button>
  <button id="admin-logout-btn">Logout Admin</button>

  <div id="admin-unlock">
    <input type="password" id="admin-password" placeholder="Password Admin" autocomplete="off"/>
    <button id="unlock-btn">Sblocca</button>
  </div>
  <div id="message"></div>
</div>

<div id="board"></div>

<script type="module">
// Firebase SDK imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAHpuw1hUg2x0U-ms8op-xw-bqUFjlU1r8",
  authDomain: "lotteria-asilo.firebaseapp.com",
  databaseURL: "https://lotteria-asilo-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "lotteria-asilo",
  storageBucket: "lotteria-asilo.appspot.com",
  messagingSenderId: "666992323953",
  appId: "1:666992323953:web:e03ddbaeffa4991d15dad0",
  measurementId: "G-PVZ1ZR0S28"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const boardDiv = document.getElementById('board');
const childNameInput = document.getElementById('childName');
const confirmBtn = document.getElementById('confirm-btn');
const adminBtn = document.getElementById('admin-btn');
const adminUnlockDiv = document.getElementById('admin-unlock');
const adminPasswordInput = document.getElementById('admin-password');
const unlockBtn = document.getElementById('unlock-btn');
const adminLogoutBtn = document.getElementById('admin-logout-btn');
const messageDiv = document.getElementById('message');

let selectedNumbers = new Set();
let isAdmin = false;
let takenNumbers = {}; // {num: {name:""}}

const ADMIN_PASSWORD = "asilo2025";

function createBoard() {
  boardDiv.innerHTML = '';
  for(let i=1; i<=180; i++) {
    const cell = document.createElement('div');
    cell.classList.add('cell');
    cell.dataset.number = i;

    const numDiv = document.createElement('div');
    numDiv.className = 'number';
    numDiv.textContent = i;

    cell.appendChild(numDiv);

    boardDiv.appendChild(cell);

    cell.addEventListener('click', () => onCellClick(i, cell));
  }
}

function onCellClick(number, cell) {
  if (takenNumbers[number] && !isAdmin) return; // occupato e non admin, blocca

  if (selectedNumbers.has(number)) {
    selectedNumbers.delete(number);
    cell.classList.remove('selected');
  } else {
    selectedNumbers.add(number);
    cell.classList.add('selected');
  }
}

function updateBoard() {
  for (const cell of boardDiv.children) {
    const num = parseInt(cell.dataset.number);
    if (takenNumbers[num]) {
      cell.classList.add('taken');
      cell.classList.remove('selected');
      let label = cell.querySelector('.child-name');
      if (!label) {
        label = document.createElement('div');
        label.className = 'child-name';
        cell.appendChild(label);
      }
      label.textContent = takenNumbers[num].name;
    } else {
      cell.classList.remove('taken');
      if (selectedNumbers.has(num)) {
        cell.classList.add('selected');
      } else {
        cell.classList.remove('selected');
      }
      const label = cell.querySelector('.child-name');
      if (label) label.remove();
    }
  }
}

// Listener Firebase database aggiornamenti in tempo reale
const dbRef = ref(db, 'prenotazioni/');
onValue(dbRef, (snapshot) => {
  const data = snapshot.val() || {};
  takenNumbers = data;
  // Deseleziona numeri occupati
  for (const n of selectedNumbers) {
    if (takenNumbers[n]) selectedNumbers.delete(n);
  }
  updateBoard();
});

confirmBtn.addEventListener('click', () => {
  messageDiv.textContent = '';
  const name = childNameInput.value.trim();
  if (!name) {
    alert("Inserisci il nome e cognome del bambino/a!");
    return;
  }
  if (selectedNumbers.size === 0) {
    alert("Seleziona almeno un numero!");
    return;
  }

  // Verifica che nessun numero selezionato sia già preso (sincronizzazione)
  for (const n of selectedNumbers) {
    if (takenNumbers[n]) {
      alert(`Il numero ${n} è già prenotato, deselezionalo.`);
      return;
    }
  }

  // Scrivi in Firebase tutte le nuove prenotazioni
  let updates = {};
  for (const n of selectedNumbers) {
    updates['prenotazioni/' + n] = { name };
  }
  update(ref(db), updates)
    .then(() => {
      messageDiv.style.color = "#006600";
      messageDiv.textContent = "Grazie, la tua prenotazione è stata registrata con successo!";
      selectedNumbers.clear();
      childNameInput.value = "";
    })
    .catch(err => {
      messageDiv.style.color = "red";
      messageDiv.textContent = "Errore durante la registrazione, riprova.";
      console.error(err);
    });
});

adminBtn.addEventListener('click', () => {
  adminUnlockDiv.style.display = 'block';
  adminPasswordInput.focus();
});

unlockBtn.addEventListener('click', () => {
  if (adminPasswordInput.value === ADMIN_PASSWORD) {
    isAdmin = true;
    adminUnlockDiv.style.display = 'none';
    adminLogoutBtn.style.display = 'inline-block';
    adminBtn.style.display = 'none';
    messageDiv.style.color = "blue";
    messageDiv.textContent = "Modalità Admin attivata: clicca su un numero preso per eliminarlo.";
  } else {
    alert("Password Admin errata!");
  }
  adminPasswordInput.value = "";
});

adminLogoutBtn.addEventListener('click', () => {
  isAdmin = false;
  adminLogoutBtn.style.display = 'none';
  adminBtn.style.display = 'inline-block';
  messageDiv.textContent = "";
});

boardDiv.addEventListener('click', async (e) => {
  if (!isAdmin) return;

  const cell = e.target.closest('.cell');
  if (!cell) return;

  const num = parseInt(cell.dataset.number);
  if (!takenNumbers[num]) return; // numero libero, niente da fare

  const conferma = confirm(`Sei sicuro di voler rimuovere la prenotazione del numero ${num} per "${takenNumbers[num].name}"?`);
  if (!conferma) return;

  try {
    const numRef = ref(db, 'numbers/' + num);
    await set(numRef, null); // elimina la prenotazione
    alert(`Prenotazione numero ${num} rimossa.`);
  } catch (error) {
    alert('Errore nella rimozione della prenotazione. Riprova.');
  }
});

// Inizializza
createBoard();
updateBoard();
</script>

</body>
</html>
